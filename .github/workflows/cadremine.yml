---
# yamllint disable rule:line-length
name: cadremine
# yamllint disable-line rule:truthy
on: push

env:
    INTERMINE_CHECKOUT: ${{ github.workspace }}/docker-intermine-gradle

jobs:
    cadremine:
        runs-on: ubuntu-latest
        steps:
            - name: Install prerequisites
              run: |
                  set -euo pipefail
                  sudo apt -y install wait-for-it
            - uses: actions/checkout@v4
              with:
                  repository: "ucam-department-of-psychiatry/docker-intermine-gradle"
                  ref: "cadre-dev"
                  path: "docker-intermine-gradle"
            - uses: actions/checkout@v4
              with:
                  path: "docker-intermine-gradle/data/mine/cadremine"
            - name: Make data dirs
              run: |
                  set -euo pipefail
                  ${INTERMINE_CHECKOUT}/mkdatadirs.sh
            - name: Up
              run: |
                  set -euo pipefail
                  cd ${INTERMINE_CHECKOUT}
                  # Use run to trap any build errors early
                  # DOCKER_UID=$(id -u) DOCKER_GID=$(id -g) MINE_NAME=cadremine docker compose -f local.docker-compose.yml run --rm intermine_builder
                  DOCKER_UID=$(id -u) DOCKER_GID=$(id -g) MINE_NAME=cadremine docker compose -f local.docker-compose.yml up -d
            - name: Wait
              run: |
                  set -euo pipefail
                  cd ${INTERMINE_CHECKOUT}
                  # Wait for builder to finish and return exit code
                  DOCKER_UID=$(id -u) DOCKER_GID=$(id -g) MINE_NAME=cadremine docker compose -f local.docker-compose.yml wait intermine_builder
                  # Wait 15 minutes
                  wait-for-it localhost:9999 --timeout=900

            - name: Check webapp
              run: |
                  set -euo pipefail
                  curl -I -L --retry 10 --fail --insecure "http://localhost:9999/cadremine/"

            - name: Dump Docker logs
              if: failure()
              run: |
                  set -euo pipefail
                  cd ${INTERMINE_CHECKOUT}
                  sleep 120
                  DOCKER_UID=$(id -u) DOCKER_GID=$(id -g) docker compose -f local.docker-compose.yml logs intermine_builder
                  DOCKER_UID=$(id -u) DOCKER_GID=$(id -g) docker compose -f local.docker-compose.yml logs postgres
                  DOCKER_UID=$(id -u) DOCKER_GID=$(id -g) docker compose -f local.docker-compose.yml logs solr
                  DOCKER_UID=$(id -u) DOCKER_GID=$(id -g) docker compose -f local.docker-compose.yml logs tomcat
